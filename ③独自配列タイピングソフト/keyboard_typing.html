<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©å¿œå‹ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ v13 (ãƒ©ãƒ³ã‚¯è‰²å¯¾å¿œ)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        body.dark-mode {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e0e0e0;
        }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
        .start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            backdrop-filter: blur(5px);
            padding: 20px;
        }
        .start-screen.active { display: flex; }
        body.dark-mode .start-screen { background: rgba(26, 26, 46, 0.95); }

        .mode-cards {
            display: flex; gap: 20px; margin: 30px 0;
            flex-wrap: wrap; justify-content: center;
        }
        .mode-card {
            background: white; border: 2px solid #ddd; border-radius: 15px;
            padding: 30px; width: 200px; text-align: center;
            cursor: pointer; transition: all 0.3s;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
        }
        body.dark-mode .mode-card { background: #2a2a3e; border-color: #444; }
        .mode-card:hover { transform: translateY(-5px); }
        .mode-card.selected {
            border-color: #667eea; background: #f0f4ff; transform: scale(1.05);
        }
        body.dark-mode .mode-card.selected { background: #1e3a5a; border-color: #667eea; }
        .mode-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .mode-title { font-weight: bold; font-size: 1.2rem; color: #333; margin-bottom: 5px; }
        body.dark-mode .mode-title { color: #e0e0e0; }
        
        .big-start-btn {
            background: linear-gradient(145deg, #667eea, #764ba2);
            color: white; border: none; padding: 20px 60px;
            border-radius: 50px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; box-shadow: 0 10px 20px rgba(118, 75, 162, 0.4);
            transition: transform 0.2s;
        }
        .big-start-btn:hover { transform: scale(1.05); }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ --- */
        .game-screen {
            display: none; width: 100%; max-width: 900px;
            flex-direction: column; align-items: center;
        }
        .game-screen.active { display: flex; }

        .container {
            background: white; border-radius: 20px; padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%;
            position: relative; overflow: hidden;
        }
        body.dark-mode .container { background: #2a2a3e; }

        /* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
        .progress-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 6px;
            background: #eee;
        }
        body.dark-mode .progress-container { background: #444; }
        .progress-bar {
            height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%; transition: width 0.3s ease;
        }

        .header-controls {
            display: flex; justify-content: space-between; align-items: center;
            width: 100%; margin-bottom: 20px; margin-top: 10px;
        }
        .back-btn {
            background: transparent; border: 2px solid #ccc; color: #666;
            padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: 600;
        }
        body.dark-mode .back-btn { border-color: #666; color: #ccc; }

        .status-badge {
            padding: 5px 12px; background: #eee; border-radius: 20px;
            font-size: 0.8rem; color: #555; margin-left: 5px;
        }
        .status-badge.active { background: #d4edda; color: #155724; }
        body.dark-mode .status-badge { background: #3a3a3a; color: #ccc; }
        body.dark-mode .status-badge.active { background: #2a4a3e; color: #d4edda; }

        .typing-area {
            background: #f8f9fa; border-radius: 15px; padding: 40px;
            margin: 20px 0; min-height: 250px; text-align: center;
            display: flex; flex-direction: column; justify-content: center;
            position: relative;
        }
        body.dark-mode .typing-area { background: #1a1a2e; }

        /* ã‚³ãƒ³ãƒœã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ */
        .combo-counter {
            position: absolute; top: 10px; right: 20px;
            font-size: 1.5rem; font-weight: 900; color: #e0e0e0;
            opacity: 0; transform: scale(0.8); pointer-events: none;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .combo-counter.show { opacity: 0.6; transform: scale(1); }
        .combo-counter.pulse { transform: scale(1.3); color: #667eea; opacity: 0.8; }
        .combo-counter span { font-size: 0.8rem; font-weight: normal; margin-left: 5px; }

        .target-hiragana {
            font-size: 28px; color: #555; margin-bottom: 15px; min-height: 36px; font-weight: bold;
        }
        body.dark-mode .target-hiragana { color: #ccc; }

        .target-romaji {
            font-size: 36px; font-family: 'Courier New', monospace;
            line-height: 1.5; word-break: break-all;
        }

        .char-group {
            display: inline-block; 
            margin: 0 1px;
            border-bottom: 2px solid transparent;
        }
        .char-group.active {
            border-bottom: 3px solid #667eea;
            background-color: rgba(102, 126, 234, 0.1);
        }

        .romaji-char.typed { color: #27ae60; text-shadow: 0 0 5px rgba(39, 174, 96, 0.2); }
        .romaji-char.untyped { color: #ccc; }
        .romaji-char.typing { color: #333; text-decoration: underline; font-weight:bold; }
        body.dark-mode .romaji-char.typing { color: #fff; text-shadow: 0 0 8px rgba(255,255,255,0.4); }

        .input-display {
            font-size: 24px; height: 40px; margin-top: 20px;
            color: #667eea; font-family: 'Courier New', monospace;
        }
        .message { height: 30px; margin-top: 10px; font-weight: bold; transition: all 0.2s; }

        /* ãƒªã‚¶ãƒ«ãƒˆç”»é¢ */
        .result {
            display: none; margin-top: 20px; padding: 30px;
            background: #fff; border: 2px solid #eee; border-radius: 15px;
            color: #333; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.05);
            animation: popIn 0.5s ease;
        }
        body.dark-mode .result { background: #2a2a3e; border-color: #444; color: #e0e0e0; }
        .result.show { display: block; }

        @keyframes popIn {
            0% { transform: scale(0.9); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        .rank-badge {
            font-size: 4rem; font-weight: 900;
            margin-bottom: 10px; display: block;
            /* è‰²ã¯JSã§åˆ¶å¾¡ã™ã‚‹ãŸã‚åˆæœŸå€¤ãªã— */
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-image: linear-gradient(45deg, #666, #999); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆD */
        }
        
        .result-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px; margin: 20px 0;
        }
        .result-box { background: #f8f9fa; padding: 15px; border-radius: 10px; }
        body.dark-mode .result-box { background: #333; }
        .res-label { font-size: 0.8rem; color: #888; display: block; margin-bottom: 5px; }
        .res-val { font-size: 1.4rem; font-weight: bold; color: #555; }
        body.dark-mode .res-val { color: #ddd; }

        .weak-keys-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        .weak-key {
            display: inline-block; padding: 5px 12px; margin: 3px;
            background: #ffebeb; color: #c0392b; border-radius: 5px; font-weight: bold;
        }
        body.dark-mode .weak-key { background: #4a2a2a; color: #ff6b6b; }

        /* ãƒ•ãƒƒã‚¿ãƒ¼çµ±è¨ˆ */
        .stats-bar {
            display: flex; justify-content: space-around;
            margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;
        }
        body.dark-mode .stats-bar { border-color: #444; }
        .stat-box { text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; }
        .stat-unit { font-size: 0.8rem; color: #888; margin-left:2px; }

        .theme-toggle {
            position: fixed; top: 20px; right: 20px;
            background: rgba(255,255,255,0.2); width: 40px; height: 40px;
            border-radius: 50%; cursor: pointer; z-index: 200;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #ccc;
        }

        .file-inputs { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .file-input-wrapper { position: relative; overflow: hidden; }
        .file-input-wrapper input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; top:0; left:0;}
        .small-btn { padding: 8px 15px; border:none; background:#eee; border-radius:5px; cursor:pointer; }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">ğŸŒ™</button>

    <div class="start-screen active" id="startScreen">
        <h1>âŒ¨ï¸ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ç·´ç¿’ v13</h1>
        <p>ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
        
        <div class="mode-cards">
            <div class="mode-card selected" id="jpModeCard">
                <span class="mode-icon">ğŸ‡¯ğŸ‡µ</span>
                <div class="mode-title">æ—¥æœ¬èª</div>
                <div class="mode-desc">ãƒ­ãƒ¼ãƒå­—å…¥åŠ›<br>(æ¼¢å­—è¡¨ç¤ºå¯¾å¿œ)</div>
            </div>
            <div class="mode-card" id="enModeCard">
                <span class="mode-icon">ğŸ‡ºğŸ‡¸</span>
                <div class="mode-title">English</div>
                <div class="mode-desc">è‹±å˜èªãƒ»æ–‡ç« <br>(å¤§æ–‡å­—ãƒ»ç©ºç™½ç„¡è¦–)</div>
            </div>
        </div>

        <div style="margin-bottom:20px; display:flex; gap:10px;">
            <span class="status-badge" id="layoutInfoStart">æ¨™æº–é…åˆ—</span>
            <span class="status-badge" id="textInfoStart">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå˜èª</span>
        </div>

        <button class="big-start-btn" id="bigStartBtn">START</button>

        <div class="file-inputs">
            <div class="file-input-wrapper">
                <button class="small-btn">ğŸ“‚ é…åˆ—èª­è¾¼ (.json)</button>
                <input type="file" id="loadLayout" accept=".json">
            </div>
            <div class="file-input-wrapper">
                <button class="small-btn">ğŸ“„ ãƒ†ã‚­ã‚¹ãƒˆ/JSONèª­è¾¼</button>
                <input type="file" id="loadText" accept=".txt,.json">
            </div>
        </div>
    </div>

    <div class="game-screen" id="gameScreen">
        <div class="container">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="header-controls">
                <button class="back-btn" id="backBtn">â† æˆ»ã‚‹</button>
                <div style="display:flex;">
                    <span class="status-badge" id="langInfo">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª</span>
                    <span class="status-badge" id="layoutInfo">æ¨™æº–é…åˆ—</span>
                </div>
                <button class="small-btn" id="resetBtn">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <div class="typing-area">
                <div class="combo-counter" id="comboCounter">0<span>COMBO</span></div>
                <div class="target-hiragana" id="targetHiragana">æº–å‚™å®Œäº†</div>
                <div class="target-romaji" id="targetRomaji"></div>
                <div class="input-display" id="inputDisplay"></div>
                <div class="message" id="message"></div>
            </div>

            <div class="result" id="result">
                <span id="rankBadge" class="rank-badge">D</span>
                <div class="result-grid">
                    <div class="result-box">
                        <span class="res-label">ã‚¹ã‚³ã‚¢</span>
                        <span class="res-val" id="resScore">0</span>
                    </div>
                    <div class="result-box">
                        <span class="res-label">WPM (é€Ÿåº¦)</span>
                        <span class="res-val" id="resWpm">0</span>
                    </div>
                    <div class="result-box">
                        <span class="res-label">æ­£ç¢ºç‡</span>
                        <span class="res-val" id="resAcc">0%</span>
                    </div>
                    <div class="result-box">
                        <span class="res-label">KPM (æ‰“éµ/åˆ†)</span>
                        <span class="res-val" id="resKpm">0</span>
                    </div>
                    <div class="result-box">
                        <span class="res-label">ãƒŸã‚¹æ•°</span>
                        <span class="res-val" id="resMiss">0</span>
                    </div>
                </div>
                <div class="weak-keys-area" id="weakKeysArea" style="display:none;">
                    <span class="res-label">è‹¦æ‰‹ãªã‚­ãƒ¼ (ã‚ˆããƒŸã‚¹ã—ãŸæ–‡å­—)</span>
                    <div id="weakKeysList"></div>
                </div>
                <div style="margin-top:20px;">
                    <button class="big-start-btn" onclick="startGame()" style="font-size:1rem; padding:10px 30px;">ã‚‚ã†ä¸€åº¦</button>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-box">
                    <div style="font-size:0.8rem; color:#888;">æ®‹ã‚Š</div>
                    <div class="stat-val" id="remaining">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.8rem; color:#888;">WPM</div>
                    <div class="stat-val" id="wpm">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.8rem; color:#888;">KPM</div>
                    <div class="stat-val" id="kpm">0</div>
                </div>
                <div class="stat-box">
                    <div style="font-size:0.8rem; color:#888;">æ­£ç¢ºç‡</div>
                    <div class="stat-val" id="accuracy">100%</div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- è¨­å®šãƒ‡ãƒ¼ã‚¿ ---
        const romajiMap = {
            'ã‚':['a'],'ã„':['i','yi'],'ã†':['u','wu','whu'],'ãˆ':['e'],'ãŠ':['o'],
            'ã‹':['ka','ca'],'ã':['ki'],'ã':['ku','cu','qu'],'ã‘':['ke'],'ã“':['ko','co'],
            'ã•':['sa'],'ã—':['si','shi','ci'],'ã™':['su'],'ã›':['se','ce'],'ã':['so'],
            'ãŸ':['ta'],'ã¡':['ti','chi'],'ã¤':['tu','tsu'],'ã¦':['te'],'ã¨':['to'],
            'ãª':['na'],'ã«':['ni'],'ã¬':['nu'],'ã­':['ne'],'ã®':['no'],
            'ã¯':['ha'],'ã²':['hi'],'ãµ':['hu','fu'],'ã¸':['he'],'ã»':['ho'],
            'ã¾':['ma'],'ã¿':['mi'],'ã‚€':['mu'],'ã‚':['me'],'ã‚‚':['mo'],
            'ã‚„':['ya'],'ã‚†':['yu'],'ã‚ˆ':['yo'],
            'ã‚‰':['ra'],'ã‚Š':['ri'],'ã‚‹':['ru'],'ã‚Œ':['re'],'ã‚':['ro'],
            'ã‚':['wa'],'ã‚’':['wo'],
            'ã‚“':['nn','xn',"n'"], 
            'ãŒ':['ga'],'ã':['gi'],'ã':['gu'],'ã’':['ge'],'ã”':['go'],
            'ã–':['za'],'ã˜':['zi','ji'],'ãš':['zu'],'ãœ':['ze'],'ã':['zo'],
            'ã ':['da'],'ã¢':['di'],'ã¥':['du'],'ã§':['de'],'ã©':['do'],
            'ã°':['ba'],'ã³':['bi'],'ã¶':['bu'],'ã¹':['be'],'ã¼':['bo'],
            'ã±':['pa'],'ã´':['pi'],'ã·':['pu'],'ãº':['pe'],'ã½':['po'],
            'ãã‚ƒ':['kya'],'ãã‚…':['kyu'],'ãã‚‡':['kyo'],
            'ã—ã‚ƒ':['sya','sha'],'ã—ã‚…':['syu','shu'],'ã—ã‚‡':['syo','sho'],
            'ã¡ã‚ƒ':['tya','cha'],'ã¡ã‚…':['tyu','chu'],'ã¡ã‚‡':['tyo','cho'],
            'ã«ã‚ƒ':['nya'],'ã«ã‚…':['nyu'],'ã«ã‚‡':['nyo'],
            'ã²ã‚ƒ':['hya'],'ã²ã‚…':['hyu'],'ã²ã‚‡':['hyo'],
            'ã¿ã‚ƒ':['mya'],'ã¿ã‚…':['myu'],'ã¿ã‚‡':['myo'],
            'ã‚Šã‚ƒ':['rya'],'ã‚Šã‚…':['ryu'],'ã‚Šã‚‡':['ryo'],
            'ãã‚ƒ':['gya'],'ãã‚…':['gyu'],'ãã‚‡':['gyo'],
            'ã˜ã‚ƒ':['zya','ja','jya'],'ã˜ã‚…':['zyu','ju','jyu'],'ã˜ã‚‡':['zyo','jo','jyo'],
            'ã³ã‚ƒ':['bya'],'ã³ã‚…':['byu'],'ã³ã‚‡':['byo'],
            'ã´ã‚ƒ':['pya'],'ã´ã‚…':['pyu'],'ã´ã‚‡':['pyo'],
            'ãµã':['fa'],'ãµãƒ':['fi'],'ãµã‡':['fe'],'ãµã‰':['fo'],
            'ã‚”':['vu'],'ã†ã‚›':['vu'],
            'ãƒ¼':['-'],'ã€‚':['.'],'ã€':[','],'ï¼':['!'],'ï¼Ÿ':['?'],
            'ã€Œ':['['],'ã€':[']'],'ï¼ˆ':['('],'ï¼‰':[')'],
            'ã£':['ltu','xtu']
        };

        const defaultJP = ['ã“ã‚“ã«ã¡ã¯','ã‚ã‚ŠãŒã¨ã†','ã•ã‚ˆã†ãªã‚‰','ãŒã‚“ã°ã‚‹','ãŸã®ã—ã„'];
        const defaultEN = ['Hello World','Good Morning','Thank you','Typing Game','Keep it simple'];

        // --- ã‚¹ãƒ†ãƒ¼ãƒˆ ---
        let practiceWords = [...defaultJP];
        let isEnglish = false;
        let isCustomLoaded = false;
        let customLayout = null;
        
        let currentText = '';
        let currentDisplay = '';
        let lastWordText = ''; 
        
        let tokens = [];
        let tokenIndex = 0;
        let inputBuffer = '';
        let typedHistory = [];

        let isPlaying = false;
        let startTime = 0;
        let totalChars = 0;
        let correctChars = 0;
        let mistakes = 0;
        let wordsDone = 0;
        let totalWords = 10;
        let combo = 0;
        let missedKeys = {};

        // --- DOM ---
        const $ = id => document.getElementById(id);
        const els = {
            startScreen: $('startScreen'), gameScreen: $('gameScreen'),
            jpCard: $('jpModeCard'), enCard: $('enModeCard'),
            startBtn: $('bigStartBtn'), backBtn: $('backBtn'),
            targetHira: $('targetHiragana'), targetRomaji: $('targetRomaji'),
            inputDisp: $('inputDisplay'), msg: $('message'), result: $('result'),
            themeToggle: $('themeToggle'), 
            wpm: $('wpm'), kpm: $('kpm'), acc: $('accuracy'), rem: $('remaining'),
            combo: $('comboCounter'), prog: $('progressBar'),
            rankBadge: $('rankBadge')
        };

        // --- åˆæœŸåŒ– ---
        if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
        els.themeToggle.onclick = () => {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light');
        };

        els.jpCard.onclick = () => {
            isCustomLoaded = false; 
            $('textInfoStart').innerText = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå˜èª';
            setMode(false);
        };
        els.enCard.onclick = () => {
            isCustomLoaded = false;
            $('textInfoStart').innerText = 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå˜èª';
            setMode(true);
        };
        
        function setMode(en) {
            isEnglish = en;
            els.jpCard.className = en ? 'mode-card' : 'mode-card selected';
            els.enCard.className = en ? 'mode-card selected' : 'mode-card';
            
            if(!isCustomLoaded) {
                practiceWords = en ? [...defaultEN] : [...defaultJP];
            }
        }

        els.startBtn.onclick = () => {
            els.startScreen.classList.remove('active');
            els.gameScreen.classList.add('active');
            els.backBtn.style.display = 'block';
            $('langInfo').innerText = isEnglish ? 'ğŸ‡ºğŸ‡¸ English' : 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª';
            startGame();
        };

        els.backBtn.onclick = () => {
            isPlaying = false;
            els.gameScreen.classList.remove('active');
            els.startScreen.classList.add('active');
            els.backBtn.style.display = 'none';
        };

        $('resetBtn').onclick = startGame;

        // --- ã‚²ãƒ¼ãƒ å‡¦ç† ---
        function startGame() {
            if(practiceWords.length === 0) return alert('å˜èªãŒã‚ã‚Šã¾ã›ã‚“');
            isPlaying = true;
            wordsDone = 0; totalChars = 0; correctChars = 0; mistakes = 0;
            combo = 0; missedKeys = {};
            startTime = Date.now();
            els.result.classList.remove('show');
            els.rem.innerText = totalWords;
            els.prog.style.width = '0%';
            updateCombo();
            lastWordText = ''; 
            nextWord();
        }

        function nextWord() {
            if(wordsDone >= totalWords) return endGame();
            
            let wordData = null;
            let tempText = '';
            let maxTries = 10; 

            if(practiceWords.length <= 1) {
                wordData = practiceWords[0];
            } else {
                do {
                    wordData = practiceWords[Math.floor(Math.random()*practiceWords.length)];
                    if(Array.isArray(wordData) && wordData.length >= 2) {
                        tempText = wordData[1];
                    } else {
                        tempText = wordData;
                    }
                    maxTries--;
                } while(tempText === lastWordText && maxTries > 0);
            }
            
            if (!wordData) { wordData = "Error"; tempText = "Error"; }

            if(Array.isArray(wordData) && wordData.length >= 2) {
                currentDisplay = wordData[0]; // æ¼¢å­—
                currentText = wordData[1];    // ã‹ãª
            } else {
                currentDisplay = wordData;
                currentText = wordData;
            }
            
            lastWordText = currentText; 
            
            if(isEnglish) {
                tokens = String(currentText).split('');
                els.targetHira.style.display = 'none';
            } else {
                tokens = tokenize(String(currentText));
                els.targetHira.innerText = currentDisplay;
                els.targetHira.style.display = 'block';
            }

            tokenIndex = 0;
            inputBuffer = '';
            typedHistory = [];
            els.inputDisp.innerText = '';
            els.msg.innerText = '';
            
            if(isEnglish) skipSpaces();

            render();
            updateStats();
        }

        function tokenize(text) {
            const res = [];
            let i = 0;
            while(i < text.length) {
                if(i < text.length-1 && romajiMap[text.slice(i,i+2)]) {
                    res.push(text.slice(i,i+2)); i+=2;
                } else {
                    res.push(text[i]); i++;
                }
            }
            return res;
        }

        document.addEventListener('keydown', e => {
            if(!isPlaying) return;
            if(e.key.length > 1) return;
            
            if(e.key === ' ') {
                e.preventDefault();
                return; 
            }
            
            e.preventDefault();

            let key = e.key;
            if(customLayout) key = applyLayout(key);
            let input = key.toLowerCase();

            if(tokenIndex >= tokens.length) return;

            let candidates = [];
            if(isEnglish) {
                candidates = [tokens[tokenIndex].toLowerCase()];
            } else {
                candidates = getCandidates(tokens[tokenIndex], tokenIndex);
            }
            
            let nextBuffer = inputBuffer + input;
            
            let exact = candidates.find(c => c === nextBuffer);
            let partial = candidates.some(c => c.startsWith(nextBuffer));

            if(partial) {
                inputBuffer = nextBuffer;
                correctChars++; totalChars++;
                combo++; 
                els.inputDisp.innerText += key; 
                
                if(exact) {
                    let histVal = isEnglish ? tokens[tokenIndex] : exact;
                    typedHistory.push(histVal);
                    
                    tokenIndex++;
                    inputBuffer = '';
                    
                    if(isEnglish) skipSpaces();
                    
                    checkCompletion();
                }
                render();
                updateCombo(true);
            } else {
                mistakes++;
                combo = 0;
                els.msg.innerText = 'Miss';
                els.msg.style.color = '#e74c3c';
                updateCombo();
                
                let expectedChar = '';
                if(candidates.length > 0) {
                    let targetStr = candidates[0];
                    if(targetStr.length > inputBuffer.length) {
                        expectedChar = targetStr[inputBuffer.length];
                    } else {
                        expectedChar = targetStr;
                    }
                }
                if(expectedChar) {
                    missedKeys[expectedChar] = (missedKeys[expectedChar] || 0) + 1;
                }
            }
            updateStats();
        });

        function skipSpaces() {
            while(tokenIndex < tokens.length && tokens[tokenIndex] === ' ') {
                typedHistory.push(' '); 
                tokenIndex++;
            }
            checkCompletion();
        }

        function checkCompletion() {
            if(tokenIndex >= tokens.length) {
                wordsDone++;
                let prog = (wordsDone / totalWords) * 100;
                els.prog.style.width = prog + '%';
                
                els.rem.innerText = totalWords - wordsDone;
                els.msg.innerText = 'OK!';
                els.msg.style.color = '#27ae60';
                setTimeout(nextWord, 150);
            }
        }

        function getCandidates(char, idx) {
            let opts = romajiMap[char] || [];
            if(char === 'ã£' && idx < tokens.length-1) {
                let next = tokens[idx+1];
                let nextOpts = romajiMap[next];
                if(nextOpts) {
                    let nextCons = new Set();
                    nextOpts.forEach(r => {
                        if(!['a','i','u','e','o'].includes(r[0])) nextCons.add(r[0]);
                    });
                    opts = [...opts, ...Array.from(nextCons)];
                }
            }
            return opts;
        }

        function render() {
            let html = '';
            tokens.forEach((t, i) => {
                let content = '';
                let cls = 'char-group';
                
                if(i < tokenIndex) {
                    let val = isEnglish ? t : (typedHistory[i] || (romajiMap[t]?romajiMap[t][0]:t));
                    content = `<span class="romaji-char typed">${val}</span>`;
                } else if(i === tokenIndex) {
                    cls += ' active';
                    if(inputBuffer) {
                        let cands = isEnglish ? [t.toLowerCase()] : getCandidates(t, i);
                        let match = cands.find(c => c.startsWith(inputBuffer)) || cands[0];
                        
                        let typedPart = match.slice(0, inputBuffer.length); 
                        let restPart = match.slice(inputBuffer.length);
                        
                        if(isEnglish) {
                            restPart = t.slice(inputBuffer.length); 
                        }

                        content = `<span class="romaji-char typing">${typedPart}</span><span class="romaji-char untyped">${restPart}</span>`;
                    } else {
                        let def = isEnglish ? t : (romajiMap[t]?romajiMap[t][0]:t);
                        content = `<span class="romaji-char untyped">${def}</span>`;
                    }
                } else {
                    let def = isEnglish ? t : (romajiMap[t]?romajiMap[t][0]:t);
                    content = `<span class="romaji-char untyped">${def}</span>`;
                }
                html += `<span class="${cls}">${content}</span>`;
            });
            els.targetRomaji.innerHTML = html;
        }

        function updateCombo(anim) {
            els.combo.innerHTML = combo + '<span>COMBO</span>';
            if(combo > 0) {
                els.combo.classList.add('show');
                if(anim) {
                    els.combo.classList.remove('pulse');
                    void els.combo.offsetWidth; 
                    els.combo.classList.add('pulse');
                }
            } else {
                els.combo.classList.remove('show');
            }
        }

        function updateStats() {
            let min = (Date.now()-startTime)/60000;
            let wpm = min>0 ? Math.round(totalChars/5/min) : 0;
            let kpm = min>0 ? Math.round(totalChars/min) : 0;
            let ac = totalChars>0 ? Math.round((correctChars/(correctChars+mistakes))*100) : 100;
            els.wpm.innerText = wpm;
            els.kpm.innerText = kpm;
            els.acc.innerText = ac+'%';
        }

        function endGame() {
            isPlaying = false;
            els.targetHira.innerText = 'çµ‚äº†ï¼';
            els.targetRomaji.innerHTML = '';
            
            let seconds = (Date.now() - startTime) / 1000;
            let min = seconds / 60;
            let wpm = min > 0 ? Math.round(totalChars / 5 / min) : 0;
            let kpm = min > 0 ? Math.round(totalChars / min) : 0;
            let accuracy = totalChars > 0 ? (correctChars / (correctChars + mistakes)) * 100 : 0;
            let accInt = Math.round(accuracy);
            
            let score = Math.round(wpm * (accuracy/100));
            
            // è‰²ã¨ãƒ©ãƒ³ã‚¯ã®åˆ¤å®š
            let rank = 'D';
            let color = 'linear-gradient(45deg, #bdc3c7, #2c3e50)'; // Gray
            
            if(score >= 100) { 
                rank = 'S+'; 
                color = 'linear-gradient(45deg, #FF00CC, #3333FF)'; // Purple-Blue
            }
            else if(score >= 80) { 
                rank = 'S'; 
                color = 'linear-gradient(45deg, #FFD700, #FDB931)'; // Gold
            }
            else if(score >= 60) { 
                rank = 'A'; 
                color = 'linear-gradient(45deg, #FF416C, #FF4B2B)'; // Red
            }
            else if(score >= 40) { 
                rank = 'B'; 
                color = 'linear-gradient(45deg, #2193b0, #6dd5ed)'; // Blue
            }
            else if(score >= 20) { 
                rank = 'C'; 
                color = 'linear-gradient(45deg, #56ab2f, #a8e063)'; // Green
            }

            els.rankBadge.innerText = rank;
            els.rankBadge.style.backgroundImage = color;

            $('resScore').innerText = score;
            $('resWpm').innerText = wpm;
            $('resAcc').innerText = accInt + '%';
            $('resKpm').innerText = kpm;
            $('resMiss').innerText = mistakes;
            
            let sortedKeys = Object.entries(missedKeys).sort((a,b) => b[1] - a[1]);
            let weakHtml = '';
            if(sortedKeys.length > 0) {
                sortedKeys.slice(0, 5).forEach(k => {
                    weakHtml += `<span class="weak-key">${k[0].toUpperCase()} (${k[1]})</span>`;
                });
                $('weakKeysArea').style.display = 'block';
                $('weakKeysList').innerHTML = weakHtml;
            } else {
                $('weakKeysArea').style.display = 'none';
            }

            els.result.classList.add('show');
        }

        // --- ãƒ•ã‚¡ã‚¤ãƒ«èª­è¾¼å‡¦ç† ---
        $('loadText').onchange = e => {
            let f = e.target.files[0];
            if(!f) return;
            let r = new FileReader();
            
            r.onload = ev => {
                let txt = ev.target.result.replace(/^\uFEFF/, '');
                let success = false;
                let loadedCount = 0;

                try {
                    let json = JSON.parse(txt);
                    if(Array.isArray(json) && json.length > 0) {
                        let fixedJson = json.map(item => {
                            if(Array.isArray(item) && item.length >= 2) {
                                item[1] = item[1].replace(/[\u30a1-\u30f6]/g, m => String.fromCharCode(m.charCodeAt(0) - 0x60));
                                return item;
                            }
                            return item;
                        });

                        practiceWords = fixedJson;
                        totalWords = Math.min(fixedJson.length, 50);
                        loadedCount = fixedJson.length;
                        isCustomLoaded = true;

                        if (Array.isArray(fixedJson[0])) {
                            setMode(false);
                            $('textInfoStart').innerText = `èª­è¾¼: ${loadedCount}èª (JP/JSON)`;
                            alert(`èª­ã¿è¾¼ã¿æˆåŠŸï¼\n${loadedCount}èªã®ãƒªã‚¹ãƒˆ(æ¼¢å­—ã‚ã‚Š)`);
                        } else {
                            let sample = fixedJson[0] || '';
                            let isJp = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾ ]/.test(sample);
                            setMode(!isJp);
                            $('textInfoStart').innerText = `èª­è¾¼: ${loadedCount}èª (JSON)`;
                            alert(`èª­ã¿è¾¼ã¿æˆåŠŸï¼\n${loadedCount}èªã®ãƒªã‚¹ãƒˆ`);
                        }
                        success = true;
                    }
                } catch(e) { }

                if (success) return;

                let hasJP = /[ã-ã‚“ã‚¡-ãƒ³ä¸€-é¾ ]/.test(txt);
                isCustomLoaded = true;

                if(hasJP) {
                    setMode(false);
                    txt = txt.replace(/[\u30a1-\u30f6]/g, m=>String.fromCharCode(m.charCodeAt(0)-0x60)); 
                    let lines = txt.split(/[ã€‚\n\r?!]+/).map(l=>l.trim()).filter(l=>/^[\u3040-\u309Fãƒ¼ã€]+$/.test(l));
                    if(lines.length){
                        practiceWords = lines;
                        totalWords = Math.min(lines.length, 50);
                        $('textInfoStart').innerText = `èª­è¾¼: ${lines.length}è¡Œ (JP/TXT)`;
                        alert(`èª­ã¿è¾¼ã¿æˆåŠŸï¼\n${lines.length}è¡Œã®æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆ`);
                    } else {
                        alert('æœ‰åŠ¹ãªæ—¥æœ¬èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        isCustomLoaded = false;
                    }
                } else {
                    setMode(true);
                    let lines = txt.split(/[\n\r]+/).map(l=>l.trim()).filter(l=>l);
                    if(lines.length){
                        practiceWords = lines;
                        totalWords = Math.min(lines.length, 50);
                        $('textInfoStart').innerText = `èª­è¾¼: ${lines.length}è¡Œ (EN/TXT)`;
                        alert(`èª­ã¿è¾¼ã¿æˆåŠŸï¼\n${lines.length}è¡Œã®è‹±èªãƒ†ã‚­ã‚¹ãƒˆ`);
                    } else {
                        alert('æœ‰åŠ¹ãªãƒ†ã‚­ã‚¹ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        isCustomLoaded = false;
                    }
                }
            };
            r.readAsText(f);
        };

        $('loadLayout').onchange = e => {
            let f = e.target.files[0];
            if(!f) return;
            let r = new FileReader();
            r.onload = ev => {
                try {
                    customLayout = JSON.parse(ev.target.result);
                    $('layoutInfoStart').innerText = 'ã‚«ã‚¹ã‚¿ãƒ é…åˆ—ON';
                    $('layoutInfo').innerText = 'ã‚«ã‚¹ã‚¿ãƒ é…åˆ—ON';
                    alert('é…åˆ—è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
                } catch{ alert('é…åˆ—ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¨ãƒ©ãƒ¼'); }
            };
            r.readAsText(f);
        };

        function applyLayout(k) {
            const map = {'q':'Q','w':'W','e':'E','r':'R','t':'T','y':'Y','u':'U','i':'I','o':'O','p':'P','a':'A','s':'S','d':'D','f':'F','g':'G','h':'H','j':'J','k':'K','l':'L','z':'Z','x':'X','c':'C','v':'V','b':'B','n':'N','m':'M', ',':',','.':'.','/':'/',';':';',':':':'};
            let upper = map[k.toLowerCase()];
            if(upper && customLayout && customLayout[upper]) {
                let m = customLayout[upper];
                return (k===k.toUpperCase() && k!==k.toLowerCase()) ? m.toUpperCase() : m.toLowerCase();
            }
            return k;
        }
    </script>
</body>
</html>